name: è‡ªåŠ¨æ›´æ–°æ’­å®¢çƒ­æ¦œå’Œå‘é€é‚®ä»¶

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 22:00 = UTC 14:00
    # æ ¼å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨
    - cron: '0 14 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

permissions:
  contents: write

jobs:
  update-and-notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: æŠ“å–è®¢é˜…æ›´æ–°
        run: python scripts/fetch_rss.py

      - name: ç”Ÿæˆ Podwise å¯¼å…¥æ¸…å•
        run: python scripts/generate_import_list.py

      - name: æ›´æ–° README
        run: python scripts/update_readme.py

      - name: æäº¤æ›´æ”¹åˆ°ä»“åº“
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸ¤– æ—¥æŠ¥æ›´æ–°: $(date +'%Y-%m-%d')" || exit 0
          git push

      # ğŸ‘‡ å‘é€é‚®ä»¶çš„æ ¸å¿ƒæ­¥éª¤
      - name: å‘é€é‚®ä»¶é€šçŸ¥
        uses: dawidd6/action-send-mail@v3
        with:
          # é‚®ä»¶æœåŠ¡å™¨é…ç½® (è¿™é‡Œä»¥ Gmail ä¸ºä¾‹ï¼Œåé¢æ•™ä½ è·å–å¯†ç )
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          
          # å‘ä»¶äººè´¦å· (éœ€è¦é…ç½®åˆ° Secrets)
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          
          # é‚®ä»¶å†…å®¹
          subject: ğŸ™ï¸ ä»Šæ—¥æ’­å®¢æ›´æ–°æ—¥æŠ¥ - ${{ steps.date.outputs.date }}
          to: ${{ secrets.MAIL_TO }} # æ”¶ä»¶äººé‚®ç®±
          from: Podwise Bot
          # ç›´æ¥æŠŠç”Ÿæˆçš„å¯¼å…¥æ¸…å•ä½œä¸ºé‚®ä»¶æ­£æ–‡å‘é€
          html_body: file://PODWISE_IMPORT.html

